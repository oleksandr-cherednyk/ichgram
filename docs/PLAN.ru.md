# План проекта ICHgram

## Executive summary
ICHgram — Instagram-подобное полнофункциональное веб‑приложение, построенное по предоставленному дизайну Figma. План делает акцент на надежной модели аутентификации, обработке медиа и real‑time чату при сохранении соответствия UX дизайну. Выбор стека нацелен на поддерживаемость, быструю итерацию и портфолио‑уровень практик (тестирование, CI, понятная архитектура).

## Описание проекта
- Название: ICHgram
- Тип: Instagram‑подобное полнофункциональное веб‑приложение, созданное по Figma
- Основные требования UI: AppShell с левым сайдбаром и основной областью, страницы (Home с сеткой фида, Explore с медиасеткой, Profile, Messages), оверлеи (Search panel, Notifications panel), страницы аутентификации (Login, Sign up, Reset password)
- Ключевые функции: auth (register/login/logout/refresh/me), посты CRUD + загрузка изображений + модальное окно поста + сетки фида/эксплора, лайки (optimistic), комментарии (пагинация), профиль по username + редактирование + загрузка аватара, поиск в оверлее (Users + Tags, с дебаунсом), хэштеги (извлечение/нормализация + поиск + страница /tags/:tag), уведомления (like/comment; follow — опционально), чат (REST‑история + Socket.io realtime, optimistic send, виртуализация)

## Deliverables
### Определение MVP
- Полный auth flow (register/login/logout/refresh/me) с httpOnly refresh cookie
- AppShell + обязательные страницы/оверлеи из Figma
- CRUD постов с загрузкой изображения + модалка поста + сетки фида/эксплора
- Лайки + комментарии с пагинацией
- Профиль: просмотр/редактирование + загрузка аватара
- Search overlay для пользователей и тегов, страница тега с пагинацией
- Notifications overlay с событиями like/comment
- Чат с REST‑историей, realtime, optimistic send и виртуализацией списка

### Определение portfolio‑ready
- MVP плюс: качественная обработка ошибок, стабильное кэширование/инвалидация, базовые тесты для auth/постов/чата, CI, документация архитектуры/безопасности/перфоманса, и согласованная UX‑детализация (loading/empty/error состояния)

---

## Roadmap (11 фаз)

### Фаза 1 — Фундаменты и документация
**Цель:** Зафиксировать структуру проекта, базу документации и ожидания по инструментам.

**Tasks**
- Создать набор документации и добавить ссылку в README
  - [ ] Составить план, архитектуру, безопасность, производительность, API overview
  - [ ] Добавить раздел Documentation в README
- Определить переменные окружения и список секретов
  - [ ] Перечень env vars для клиента/сервера
  - [ ] Отличия dev/prod (cookie flags, CORS origins)
- Подтвердить структуру репозитория (/apps/client, /apps/server)
  - [ ] Описать границы ответственности папок
  - [ ] Отметить подход к типам (локально в клиенте)
- Зафиксировать контракт формата ошибок
  - [ ] Определить JSON‑формат ошибки
  - [ ] Документировать основные error codes
- Описать стратегию тестирования
  - [ ] Выделить критические пользовательские потоки
  - [ ] Определить уровень покрытий

**Definition of Done (DoD)**
- Документация создана и связана с README
- Контракт ошибок и env vars описаны
- Стратегия тестов сформулирована

**Dependencies:** нет

---

### Фаза 2 — Каркас backend и базы данных
**Цель:** Создать структуру сервера и базовые модели данных.

**Tasks**
- Инициализировать структуру /apps/server (routes/controllers/services/models/middlewares)
  - [ ] Создать папки и экспортные индексы
  - [ ] Добавить базовые конфиги
- Настроить подключение MongoDB и конфиг
  - [ ] Централизовать соединение
  - [ ] Добавить graceful shutdown
- Определить базовые модели: User, Post, Comment, Like
  - [ ] Поля и индексы отмечены в docs
  - [ ] Правила владения объектами
- Подготовить слой валидаций (Zod)
  - [ ] Валидаторы по доменам
  - [ ] Единый middleware валидации
- Определить контракт пагинации
  - [ ] Формат курсора и размер страницы
  - [ ] Единый формат метаданных

**DoD**
- Структура папок и список моделей определены
- Подход к валидации и пагинации описан

**Dependencies:** Фаза 1

---

### Фаза 3 — Auth, сессии и безопасность
**Цель:** Реализовать модель аутентификации и базовые контроли безопасности.

**Tasks**
- Реализовать auth endpoints (register/login/logout/refresh/me)
  - [ ] Схемы request/response
  - [ ] TTL access token + refresh cookie
- Настроить строгий CORS + cookies
  - [ ] Разрешить только клиентский origin
  - [ ] Включить credentials где нужно
- Добавить rate limit для auth
  - [ ] Ограничить register/login/refresh
  - [ ] Задокументировать пороги
- Реализовать auth middleware + guards
  - [ ] Проверка JWT
  - [ ] Прикрепление пользователя к request
- Добавить хеширование паролей и UI reset (если нужно)
  - [ ] Интеграция bcrypt
  - [ ] Заглушка для reset flow (UI)

**DoD**
- Auth flow полностью работает с refresh cookies
- Rate limiting и CORS настроены
- Auth middleware задокументирован

**Dependencies:** Фаза 2

---

### Фаза 4 — Медиа‑пайплайн и CRUD постов
**Цель:** Обеспечить загрузку изображений и CRUD операций для постов.

**Tasks**
- Реализовать загрузку медиа (multer + sharp)
  - [ ] Ограничения размера/типа
  - [ ] Нормализация выходных форматов/размеров
- Создать endpoints для постов (create/read/update/delete)
  - [ ] Проверка владения для edit/delete
  - [ ] Поддержка получения поста для модалки
- Реализовать feed/explore endpoints с пагинацией
  - [ ] Cursor‑based списки
  - [ ] Сортировка по createdAt
- Добавить метаданные поста для UI
  - [ ] Краткие данные автора, счетчики
  - [ ] Временные метки
- Документировать стратегию хранения файлов
  - [ ] Путь для dev или абстракция стораджа

**DoD**
- CRUD постов работает с обработкой изображений
- Feed/Explore paginated endpoints готовы

**Dependencies:** Фаза 3

---

### Фаза 5 — Хэштеги и discovery по тегам
**Цель:** Реализовать извлечение хэштегов и поиск по тегам.

**Tasks**
- Извлечение хэштегов из caption на backend
  - [ ] Нормализация: lowercase, letters/digits/_
  - [ ] Удаление дублей, максимум 10
- Хранение в Post.hashtags[] с индексом
  - [ ] Multikey индекс на hashtags
  - [ ] Подтверждение в схеме
- Endpoint поиска тегов для overlay
  - [ ] Поиск по частичному совпадению
  - [ ] Возврат счетчиков
- Endpoint страницы тега /tags/:tag с пагинацией
  - [ ] Посты по тегу с курсором
  - [ ] Возвращать total count
- Обновить API docs правилами хэштегов
  - [ ] Описать валидацию
  - [ ] Примечания по edge cases

**DoD**
- Хэштеги извлекаются, индексируются и ищутся
- Страница тега доступна

**Dependencies:** Фаза 4

---

### Фаза 6 — Лайки, комментарии, уведомления
**Цель:** Реализовать взаимодействия и базовые уведомления.

**Tasks**
- Реализовать endpoints лайков
  - [ ] Like/unlike с уникальным индексом
  - [ ] Idempotent ответы
- Реализовать endpoints комментариев с пагинацией
  - [ ] Создание/удаление комментария
  - [ ] Cursor pagination
- Создать модель и endpoints уведомлений
  - [ ] Уведомления о лайках/комментариях
  - [ ] Read/unread (опционально)
- Соблюсти правила авторизации
  - [ ] Только владелец может удалять свой контент
  - [ ] Уведомления доступны владельцу
- Обновить счетчики взаимодействий
  - [ ] Инкремент/декремент в посте
  - [ ] Единый формат ответа

**DoD**
- Лайки и комментарии работают с пагинацией
- Уведомления для like/comment поддержаны

**Dependencies:** Фаза 5

---

### Фаза 7 — Поиск и профили
**Цель:** Реализовать поиск пользователей и профильные функции.

**Tasks**
- Endpoint поиска пользователей для overlay
  - [ ] Поддержка дебаунса
  - [ ] Базовая пагинация
- Просмотр профиля по username
  - [ ] Публичные данные профиля
  - [ ] Список постов с пагинацией
- Редактирование профиля и загрузка аватара
  - [ ] Обновление имени/био
  - [ ] Загрузка аватара через медиа‑пайплайн
- Опциональная модель follow (scope‑cut)
  - [ ] Follow/unfollow endpoints
  - [ ] Уникальный составной индекс
- Документировать ответы поиска
  - [ ] User + Tag ответы
  - [ ] Рекомендации по empty state

**DoD**
- Search overlay endpoints для users/tags
- Профиль: просмотр/редактирование + аватар

**Dependencies:** Фаза 6

---

### Фаза 8 — Чат и realtime слой
**Цель:** Реализовать REST‑историю чата и realtime через Socket.io.

**Tasks**
- Создать модели Conversation и Message
  - [ ] Список участников
  - [ ] Индекс conversationId + createdAt
- Реализовать REST endpoints чата
  - [ ] Список диалогов
  - [ ] Cursor pagination сообщений
- Реализовать Socket.io события
  - [ ] Send/receive message
  - [ ] Payload для delivery ack
- Соблюсти авторизацию чата
  - [ ] Только участники читают/пишут
  - [ ] Валидация payload через Zod
- Документировать realtime контракт
  - [ ] События и payload
  - [ ] Ожидаемая обработка ошибок

**DoD**
- Чат REST + Socket.io работают
- Авторизация и валидация обеспечены

**Dependencies:** Фаза 7

---

### Фаза 9 — Frontend shell и shared UI
**Цель:** Собрать базовый UI‑каркас и общие компоненты.

**Tasks**
- Реализовать AppShell по Figma
  - [ ] Левый sidebar + main content
  - [ ] Правила адаптива
- Настроить роутинг
  - [ ] Pages: Home, Explore, Profile, Messages
  - [ ] Auth: Login, Sign up, Reset password
- Настроить слои состояния
  - [ ] React Query client + defaults
  - [ ] Zustand store для оверлеев/модалок
- Создать shared UI примитивы
  - [ ] Buttons, inputs, modal panel, cards
  - [ ] Skeleton/loading состояния
- Добавить базовый API клиент и обработку ошибок
  - [ ] Парсинг стандартного error shape
  - [ ] Toast/inline паттерны

**DoD**
- AppShell и роуты отображаются
- Shared UI и state layers готовы

**Dependencies:** Фаза 8

---

### Фаза 10 — Страницы и оверлеи
**Цель:** Реализовать UI страниц и подключить к API.

**Tasks**
- Home feed + post modal
  - [ ] Сетка фида с пагинацией
  - [ ] Модалка поста с комментариями
- Explore grid + tag page
  - [ ] Explore infinite scroll
  - [ ] /tags/:tag grid с пагинацией
- Search overlay и Notifications overlay
  - [ ] Debounced search users/tags
  - [ ] Список уведомлений и read state
- Profile page
  - [ ] Просмотр по username
  - [ ] Редактирование профиля + аватар
- Messages page
  - [ ] Список диалогов
  - [ ] Чат с react-virtuoso

**DoD**
- Все требуемые страницы/оверлеи подключены к API
- Loading/empty/error состояния присутствуют

**Dependencies:** Фаза 9

---

### Фаза 11 — Quality, performance, CI
**Цель:** Закрепить производительность, тесты и CI.

**Tasks**
- Добавить критические API тесты (auth/posts/chat)
  - [ ] Supertest suites
  - [ ] Стратегия сидов
- Добавить правила client performance
  - [ ] Инвалидация для likes/comments/posts/hashtags
  - [ ] Избегать дублей запросов
- Документировать и проверить индексы
  - [ ] Все обязательные индексы есть
  - [ ] Стратегия миграций
- Финализировать CI pipeline
  - [ ] Lint, test, build steps
  - [ ] Условия провала
- UX‑полировка и аудит ошибок
  - [ ] Сетевые ошибки
  - [ ] Retry паттерны

**DoD**
- Критические тесты проходят
- Performance требования соблюдены и документированы
- CI pipeline описан

**Dependencies:** Фаза 10

---

## Scope cuts (если не хватает времени)
- Follow/following система (опционально)
- Typing indicators и read receipts в чате
- Trending tags или аналитика тегов
- Read/unread состояния уведомлений
- Recent search history (клиент‑only)

## Suggested PR strategy
- Один issue = один PR, имена `feature/<issue-title>` или `fix/<issue-title>`
- Держать PR до ~300 строк, крупные задачи делить
- В описании PR короткий чеклист (what/why/test)
- Предпочтительно squash merge; чистые, императивные commit сообщения
